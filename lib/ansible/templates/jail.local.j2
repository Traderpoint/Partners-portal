# Fail2Ban Configuration for {{ server_hostname }}
# Generated by Systrix VPS Management

[DEFAULT]
# Ban IP for 1 hour (3600 seconds)
bantime = 3600

# Find time window (10 minutes)
findtime = 600

# Number of failures before ban
maxretry = 5

# Destination email for notifications
destemail = {{ customer.email | default('admin@example.com') }}

# Sender email
sender = fail2ban@{{ server_hostname }}

# Email actions
action = %(action_mwl)s

# Ignore local IPs
ignoreip = 127.0.0.1/8 ::1 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16

# Backend for log processing
backend = auto

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 1800

{% if 'nginx' in applications %}
[nginx-http-auth]
enabled = true
filter = nginx-http-auth
port = http,https
logpath = /var/log/nginx/error.log
maxretry = 3

[nginx-limit-req]
enabled = true
filter = nginx-limit-req
port = http,https
logpath = /var/log/nginx/error.log
maxretry = 10
findtime = 600
bantime = 600

[nginx-botsearch]
enabled = true
filter = nginx-botsearch
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 2
{% endif %}

{% if 'wordpress' in applications %}
[wordpress]
enabled = true
filter = wordpress
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 3
findtime = 600
bantime = 3600

[wordpress-hard]
enabled = true
filter = wordpress-hard
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 1
findtime = 600
bantime = 86400
{% endif %}

{% if 'mysql' in applications %}
[mysqld-auth]
enabled = true
filter = mysqld-auth
port = 3306
logpath = /var/log/mysql/error.log
maxretry = 3
{% endif %}

{% if 'php' in applications %}
[php-url-fopen]
enabled = true
filter = php-url-fopen
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 1
findtime = 600
bantime = 3600
{% endif %}

# Custom filters for common attacks
[apache-badbots]
enabled = true
filter = apache-badbots
port = http,https
logpath = /var/log/nginx/access.log
bantime = 86400
maxretry = 1

[apache-noscript]
enabled = true
filter = apache-noscript
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 6

[apache-overflows]
enabled = true
filter = apache-overflows
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 2

[apache-nohome]
enabled = true
filter = apache-nohome
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 2

# Recidive jail for repeat offenders
[recidive]
enabled = true
filter = recidive
logpath = /var/log/fail2ban.log
action = %(action_mwl)s
bantime = 604800  ; 1 week
findtime = 86400   ; 1 day
maxretry = 5
